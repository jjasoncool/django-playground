version: "3.9"

services:
  django:
    build:
      context: "./django/"
      args:
        PY_VER: ${PY_VER}
        PROJECT_NAME: ${PROJECT_NAME}
        ALLOWED_HOSTS: ${ALLOWED_HOSTS}
        CSRF_TRUSTED_ORIGINS: ${CSRF_TRUSTED_ORIGINS}
        SUB_PATH: ${SUB_PATH}
        TIMEZONE: ${TIMEZONE}
        LANGCODE: ${LANGCODE}
    environment:
      - TZ=Asia/Taipei
    depends_on:
      - db
    expose:
      - "${DJANGO_PORT}"
    volumes:
      - django-src:/usr/src/app
    container_name: "${DJANGO_NAME}"
    restart: always

  nginx:
    build:
      context: "./nginx/"
      args:
        NGINX_VERSION: ${NGINX_VERSION}
    environment:
      - TZ=Asia/Taipei
      - NGINX_PORT=${NGINX_PORT}
    depends_on:
      - django
    ports:
      - 8000:${NGINX_PORT}
    volumes:
      - nginx-config:/etc/nginx/templates/
      - ./src/${PROJECT_NAME}/static:/usr/share/nginx/html/static
      - ./src/${PROJECT_NAME}/media:/usr/share/nginx/html/media
    container_name: "${NGINX_NAME}"
    restart: always

  db:
    image: mariadb:${DB_VERSION}
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASS}
      MYSQL_DATABASE: ${DB_DATABASE}
    container_name: ${DB_NAME}
    ports:
      - ${DB_PORT}
    volumes:
      - /var/lib/mysql
    restart: always

  celery:
    build:
      context: "./celery/"
      args:
        PY_VER: ${PY_VER}
    environment:
      - TZ=Asia/Taipei
    depends_on:
      - db
    volumes:
      - django-src:/usr/src/app
    container_name: celery
    restart: always

  selenium-hub:
    image: selenium/hub:latest
    container_name: selenium_hub
    ports:
      - "4442:4442"
      - "4443:4443"
      - "4444:4444"

  selenium-node-chrome:
    # Selenium 版本有包含瀏覽器版號或者 selenium 版本
    image: selenium/node-chrome:${SELENIUM_VER}
    shm_size: 2gb  # 設置共享內存，防止瀏覽器崩潰
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub  # 指定 Hub 的地址
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - VNC_PASSWORD=${VNC_CHROME_PASS}  # 可選，自定義 VNC 密碼
    ports:
      - "5900:5900"  # 傳統 VNC 連接 port
      - "7900:7900"  # NoVNC Web 介面 port
    container_name: selenium_node_chrome
    depends_on:
      - selenium-hub

volumes:
  django-src:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "./src/"
    external: false

  nginx-config:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "./config/nginx/"
    external: false

networks:
  default:
    external:
      name: ${NET_WORK}
